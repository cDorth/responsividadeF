{% load static %}
<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamifica√ß√£o - {{ user.username }}</title>
    <link rel="stylesheet" href="{% static 'gamification/css/style.css' %}">
</head>

<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <h1>{{ user.tenant.nome }}</h1>
            </div>
        </div>

        <div class="header-right">
            {% if user.is_staff %}
            <a href="{% url 'game_staff' %}" class="btn-staff">Staff</a>
            {% endif %}
            <div class="user-info">
                {% if user.foto %}
                    <img src="{{ user.foto.url }}" alt="{{ user.username }}" class="user-avatar-small">
                {% else %}
                    <div class="user-avatar-small default-avatar">
                        {{ user.username|slice:":1"|upper }}
                    </div>
                {% endif %}
                <span><a href="{% url 'home' %}">{{ user.username }}</a></span>
            </div>
        </div>
    </header>

    <div class="main-wrapper">
        <aside class="sidebar-left">
            <div class="profile-card">
                {% if user.foto %}
                    <img src="{{ user.foto.url }}" alt="{{ user.username }}" class="profile-avatar-large">
                {% else %}
                    <div class="default-avatar-large">
                        {{ user.username|slice:":1"|upper }}
                    </div>
                {% endif %}
                
                <h3>{{ user.first_name }} {{ user.last_name }}</h3>
                <p class="profile-username">@{{ user.username }}</p>

                {% if points %}
                    {% for point in points %}
                    <div class="points-display">
                        <div class="points-current">{{ point.points_atual }}</div>
                        <div class="points-label">Pontos Atuais</div>
                    </div>

                    <div class="level-badge">
                        N√≠vel {{ point.nivel }}
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">{{ point.points_total }}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ user_tasks|length }}</div>
                            <div class="stat-label">Tarefas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ conquistas|length }}</div>
                            <div class="stat-label">Conquistas</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="points-display">
                        <div class="points-current">0</div>
                        <div class="points-label">Pontos Atuais</div>
                    </div>
                    <div class="level-badge">
                        N√≠vel Iniciante
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ user_tasks|length }}</div>
                            <div class="stat-label">Tarefas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ conquistas|length }}</div>
                            <div class="stat-label">Conquistas</div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="quick-actions">
                <h4>Navega√ß√£o R√°pida</h4>
                <div class="action-item active" data-tab-link="tarefas">
                    <div class="action-icon">üìã</div>
                    <span>Minhas Tarefas</span>
                </div>
                <div class="action-item" data-tab-link="ranking">
                    <div class="action-icon">üèÜ</div>
                    <span>Ranking Mensal</span>
                </div>
                <div class="action-item" data-tab-link="conquistas">
                    <div class="action-icon">üéñÔ∏è</div>
                    <span>Conquistas</span>
                </div>
                <div class="action-item" data-tab-link="ranking_geral">
                    <div class="action-icon">üåç</div>
                    <span>Ranking Geral</span>
                </div>
            </div>
        </aside>

        <main class="content-center">
            <div class="mobile-stats">
                <div class="mobile-stats-header">
                    {% if user.foto %}
                        <img src="{{ user.foto.url }}" alt="{{ user.username }}" class="mobile-stats-avatar">
                    {% else %}
                        <div class="mobile-stats-avatar-default">
                            {{ user.username|slice:":1"|upper }}
                        </div>
                    {% endif %}
                    <div class="mobile-stats-info">
                        <h3>{{ user.first_name }} {{ user.last_name }}</h3>
                        <p>@{{ user.username }}</p>
                    </div>
                </div>
                <div class="mobile-stats-grid">
                    {% if points %}
                        {% for point in points %}
                        <div class="mobile-stat-item">
                            <div class="mobile-stat-value">{{ point.points_atual }}</div>
                            <div class="mobile-stat-label">Pontos</div>
                        </div>
                        <div class="mobile-stat-item">
                            <div class="mobile-stat-value">{{ point.nivel }}</div>
                            <div class="mobile-stat-label">N√≠vel</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="mobile-stat-item">
                            <div class="mobile-stat-value">0</div>
                            <div class="mobile-stat-label">Pontos</div>
                        </div>
                        <div class="mobile-stat-item">
                            <div class="mobile-stat-value">1</div>
                            <div class="mobile-stat-label">N√≠vel</div>
                        </div>
                    {% endif %}
                    <div class="mobile-stat-item">
                        <div class="mobile-stat-value">{{ conquistas|length }}</div>
                        <div class="mobile-stat-label">Conquistas</div>
                    </div>
                </div>
            </div>

            <div class="tabs-container">
                <div class="tab active" data-tab="tarefas">
                    <span class="tab-icon">üìã</span>
                    <span>Tarefas</span>
                </div>
                <div class="tab" data-tab="ranking">
                    <span class="tab-icon">üèÜ</span>
                    <span>Ranking</span>
                </div>
                <div class="tab" data-tab="conquistas">
                    <span class="tab-icon">üéñÔ∏è</span>
                    <span>Conquistas</span>
                </div>
                <div class="tab" data-tab="ranking_geral">
                    <span class="tab-icon">üåç</span>
                    <span>Geral</span>
                </div>
            </div>

            <section id="tarefas" class="tab-content active">
                <div class="section-header">
                    <div class="section-title">
                        <h2>Minhas Tarefas</h2>
                        <p>Complete tarefas para ganhar pontos e subir no ranking</p>
                    </div>
                    <div class="section-stats">
                        <div class="section-stat">
                            <div class="section-stat-value">{{ user_tasks|length }}</div>
                            <div class="section-stat-label">Total</div>
                        </div>
                    </div>
                </div>

                <div class="tasks-grid">
                    {% if user_tasks %}
                        {% for user_task in user_tasks %}
                        <article class="task-card {% if user_task.concluido %}completed{% else %}pending{% endif %}">
                            <div class="task-header">
                                <div class="task-title">
                                    {{ user_task.task.titulo }}
                                </div>
                                <div class="task-points">
                                    {{ user_task.task.pontos }} pts
                                </div>
                            </div>
                            
                            <div class="task-description">
                                {{ user_task.task.descricao }}
                            </div>
                            
                            <div class="task-footer">
                                <div class="task-status {% if user_task.concluido %}done{% else %}pending{% endif %}">
                                    {% if user_task.concluido %}Conclu√≠da{% else %}Pendente{% endif %}
                                </div>

                                {% if user_task.task.conquista %}
                                <div class="task-reward">
                                    Recompensa: {{ user_task.task.conquista.nome }}
                                </div>
                                {% endif %}

                                {% if not user_task.concluido %}
                                <form method="POST" action="{% url 'concluir_tarefa' user_task.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-complete">
                                        Concluir Tarefa
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </article>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>Nenhuma tarefa atribu√≠da</h3>
                            <p>Voc√™ ainda n√£o possui tarefas. Entre em contato com um administrador para receber novas miss√µes!</p>
                        </div>
                    {% endif %}
                </div>
            </section>

            <section id="ranking" class="tab-content">
                <div class="section-header">
                    <div class="section-title">
                        <h2>Ranking Mensal</h2>
                        <p>Veja quem est√° liderando este m√™s</p>
                    </div>
                </div>

                <div class="ranking-container">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Usu√°rio</th>
                                <th>Pontos do M√™s</th>
                                <th>N√≠vel</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in ranking %}
                            <tr class="{% if r.user == request.user %}current-user{% endif %}">
                                <td>
                                    <span class="position-badge {% if r.posicao == 1 %}gold{% elif r.posicao == 2 %}silver{% elif r.posicao == 3 %}bronze{% else %}normal{% endif %}">
                                        {{ r.posicao }}
                                    </span>
                                </td>
                                <td>
                                    <div class="user-cell">
                                        {% if r.user.foto %}
                                            <img src="{{ r.user.foto.url }}" alt="{{ r.user.username }}">
                                        {% else %}
                                            <div class="default-avatar-small">{{ r.user.username|slice:":1"|upper }}</div>
                                        {% endif %}
                                        <span>{{ r.user.username }}</span>
                                    </div>
                                </td>
                                <td class="points-cell">{{ r.points_atual }} pts</td>
                                <td>
                                    <span class="level-cell">
                                        N√≠vel {{ r.nivel }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">
                                    <div class="empty-state">
                                        <div class="empty-icon">üèÜ</div>
                                        <h3>Nenhum dado de ranking</h3>
                                        <p>O ranking ainda n√£o possui participantes este m√™s.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if user_line and user_line.posicao > 5 %}
                    <div class="user-position-summary">
                        <p>
                            <strong>Sua posi√ß√£o:</strong> {{ user_line.posicao }}¬∫ lugar com {{ user_line.points_atual }} pontos este m√™s.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </section>

            <section id="conquistas" class="tab-content">
                <div class="section-header">
                    <div class="section-title">
                        <h2>Suas Conquistas</h2>
                        <p>Medalhas e recompensas que voc√™ desbloqueou</p>
                    </div>
                    <div class="section-stats">
                        <div class="section-stat">
                            <div class="section-stat-value">{{ conquistas|length }}</div>
                            <div class="section-stat-label">Conquistas</div>
                        </div>
                    </div>
                </div>

                <div class="achievements-grid">
                    {% for c in conquistas %}
                    <div class="achievement-card">
                        <div class="achievement-icon">
                            {% if c.conquista.imagem %}
                                <img src="{{ c.conquista.imagem.url }}" alt="{{ c.conquista.nome }}">
                            {% else %}
                                <span class="placeholder-icon">üèÖ</span>
                            {% endif %}
                        </div>
                        <h3>{{ c.conquista.nome }}</h3>
                        <p>{{ c.conquista.descricao }}</p>
                        <div class="achievement-date">
                            Obtida em {{ c.recebido_em | date:"d/m/Y" }}
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">üéñÔ∏è</div>
                        <h3>Nenhuma conquista ainda</h3>
                        <p>Complete tarefas para desbloquear conquistas incr√≠veis!</p>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <section id="ranking_geral" class="tab-content">
                <div class="section-header">
                    <div class="section-title">
                        <h2>Ranking Geral</h2>
                        <p>Classifica√ß√£o de todos os tempos</p>
                    </div>
                </div>

                <div class="ranking-container">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Usu√°rio</th>
                                <th>Pontos Totais</th>
                                <th>N√≠vel</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in ranking_geral %}
                            <tr class="{% if r.user == request.user %}current-user{% endif %}">
                                <td>
                                    <span class="position-badge {% if r.posicao == 1 %}gold{% elif r.posicao == 2 %}silver{% elif r.posicao == 3 %}bronze{% else %}normal{% endif %}">
                                        {{ r.posicao }}
                                    </span>
                                </td>
                                <td>
                                    <div class="user-cell">
                                        {% if r.user.foto %}
                                            <img src="{{ r.user.foto.url }}" alt="{{ r.user.username }}">
                                        {% else %}
                                            <div class="default-avatar-small">{{ r.user.username|slice:":1"|upper }}</div>
                                        {% endif %}
                                        <span>{{ r.user.username }}</span>
                                    </div>
                                </td>
                                <td class="points-cell">{{ r.points_total }} pts</td>
                                <td>
                                    <span class="level-cell">
                                        N√≠vel {{ r.nivel }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">
                                    <div class="empty-state">
                                        <div class="empty-icon">üåç</div>
                                        <h3>Nenhum dado de ranking</h3>
                                        <p>O ranking geral ainda n√£o possui participantes.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if user_line_geral and user_line_geral.posicao > 5 %}
                    <div class="user-position-summary">
                        <p>
                            <strong>Sua posi√ß√£o geral:</strong> {{ user_line_geral.posicao }}¬∫ lugar com {{ user_line_geral.points_total }} pontos no total.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </section>
        </main>

        <aside class="sidebar-right">
            <div class="leaderboard-preview">
                <h3>Top 5 do M√™s</h3>
                {% for r in ranking|slice:":5" %}
                <div class="leaderboard-item {% if forloop.first %}top-1{% endif %}">
                    <span class="leaderboard-position {% if forloop.first %}gold{% endif %}">{{ r.posicao }}¬∫</span>
                    {% if r.user.foto %}
                        <img src="{{ r.user.foto.url }}" alt="{{ r.user.username }}" class="leaderboard-avatar">
                    {% else %}
                        <div class="leaderboard-avatar-default">{{ r.user.username|slice:":1"|upper }}</div>
                    {% endif %}
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">{{ r.user.username }}</div>
                        <div class="leaderboard-points">{{ r.points_atual }} pts</div>
                    </div>
                </div>
                {% empty %}
                <p style="text-align: center; color: #65676b; padding: 20px;">Nenhum participante ainda</p>
                {% endfor %}
            </div>

            <div class="progress-card">
                <h3>Seu Progresso</h3>
                {% if points %}
                    {% for point in points %}
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>N√≠vel {{ point.nivel }}</span>
                            <strong>{{ point.points_atual }}/{{ point.nivel|add:1|stringformat:"d" }}00 pts</strong>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {% widthratio point.points_atual point.nivel|add:1 100 %}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>N√≠vel Iniciante</span>
                            <strong>0/100 pts</strong>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="tips-card">
                <h3>Dica</h3>
                <p>Complete suas tarefas di√°rias para subir no ranking e desbloquear conquistas exclusivas!</p>
            </div>
        </aside>
    </div>

    <script src="{% static 'gamification/js/gamification_script.js' %}"></script>
</body>
</html>
